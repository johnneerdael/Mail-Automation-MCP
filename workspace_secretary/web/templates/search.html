{% extends "base.html" %}
{% block title %}Search - Secretary{% endblock %}

{% block content %}
<div class="space-y-6" x-data="{ showFilters: false, showSaveModal: false }">
    <form action="/search" method="get" class="space-y-4">
        <div class="flex flex-col sm:flex-row gap-4">
            <div class="flex-1 relative">
                <input type="text" 
                       name="q" 
                       value="{{ query }}"
                       placeholder="Search emails..."
                       autocomplete="off"
                       hx-get="/search/suggestions"
                       hx-trigger="keyup changed delay:300ms"
                       hx-target="#suggestions"
                       class="input-field w-full">
                <div id="suggestions" class="absolute z-10 w-full mt-1"></div>
            </div>
            <div class="flex gap-2">
                <button type="button" 
                        @click="showFilters = !showFilters"
                        class="btn-secondary whitespace-nowrap"
                        :class="{ 'bg-primary/10 border-primary text-primary': showFilters }">
                    <span class="flex items-center gap-2">
                        <span>üîΩ Filters</span>
                        {% if filters.from_addr or filters.date_from or filters.date_to or filters.has_attachments is not none or filters.is_unread is not none %}
                        <span class="w-2 h-2 bg-primary rounded-full"></span>
                        {% endif %}
                    </span>
                </button>
                <button type="submit" 
                        class="btn-primary whitespace-nowrap">
                    Search
                </button>
            </div>
        </div>
        
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <div class="flex items-center space-x-6">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="radio" name="mode" value="keyword" {% if mode == 'keyword' %}checked{% endif %}
                           hx-get="/search" 
                           hx-trigger="change" 
                           hx-include="[name='q'], [name='folder']"
                           hx-target="body"
                           hx-swap="outerHTML"
                           class="text-primary bg-surface border-border focus:ring-primary">
                    <span class="text-sm text-body">Keyword Search</span>
                </label>
                {% if supports_semantic %}
                <label class="flex items-center space-x-2 cursor-pointer group">
                    <input type="radio" name="mode" value="semantic" {% if mode == 'semantic' %}checked{% endif %}
                           hx-get="/search" 
                           hx-trigger="change" 
                           hx-include="[name='q'], [name='folder']"
                           hx-target="body"
                           hx-swap="outerHTML"
                           class="text-primary bg-surface border-border focus:ring-primary">
                    <span class="text-sm text-body flex items-center gap-1.5">
                        <span class="text-purple-500">‚ú®</span> Semantic (AI)
                        <span class="text-xs text-muted group-hover:text-body transition-colors">(find by meaning)</span>
                    </span>
                </label>
                {% else %}
                <label class="flex items-center space-x-2 opacity-50 cursor-not-allowed">
                    <input type="radio" name="mode" value="semantic" disabled
                           class="text-primary bg-surface border-border">
                    <span class="text-sm text-muted flex items-center gap-1.5">
                        <span>‚ú®</span> Semantic (AI)
                        <span class="text-xs">(requires embeddings enabled)</span>
                    </span>
                </label>
                {% endif %}
            </div>
            
            <div class="flex items-center gap-2 w-full sm:w-auto">
                <label class="text-sm text-muted whitespace-nowrap">Folder:</label>
                <select name="folder" class="input-field py-1 text-sm">
                    {% for f in folders %}
                    <option value="{{ f }}" {% if f == folder %}selected{% endif %}>{{ f }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div x-show="showFilters" x-collapse class="card p-4 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                    <label class="block text-xs text-muted mb-1">From</label>
                    <input type="text" name="from" value="{{ filters.from_addr }}"
                           placeholder="sender@example.com"
                           class="input-field w-full text-sm">
                </div>
                
                <div>
                    <label class="block text-xs text-muted mb-1">Date From</label>
                    <input type="date" name="date_from" value="{{ filters.date_from }}"
                           class="input-field w-full text-sm">
                </div>
                
                <div>
                    <label class="block text-xs text-muted mb-1">Date To</label>
                    <input type="date" name="date_to" value="{{ filters.date_to }}"
                           class="input-field w-full text-sm">
                </div>
                
                <div class="flex flex-col justify-end gap-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="has_attachments" value="true"
                               {% if filters.has_attachments %}checked{% endif %}
                               class="rounded bg-surface border-border text-primary focus:ring-primary">
                        <span class="text-sm text-body">üìé Has attachments</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="is_unread" value="true"
                               {% if filters.is_unread %}checked{% endif %}
                               class="rounded bg-surface border-border text-primary focus:ring-primary">
                        <span class="text-sm text-body">‚óè Unread only</span>
                    </label>
                </div>
            </div>
            
            <div class="flex items-center justify-between pt-2 border-t border-border">
                <a href="/search" class="text-sm text-muted hover:text-body">Clear all filters</a>
                {% if query %}
                <button type="button" @click="showSaveModal = true" 
                        class="link text-sm flex items-center gap-1">
                    üíæ Save this search
                </button>
                {% endif %}
            </div>
        </div>
    </form>

    {% if saved_searches %}
    <div id="saved-searches" class="flex flex-wrap gap-2">
        <span class="text-xs text-muted self-center mr-1">Saved:</span>
        {% include "partials/saved_searches.html" %}
    </div>
    {% endif %}

    {% if active_operators %}
    <div class="flex flex-wrap gap-2 items-center">
        <span class="text-xs text-muted">Active filters:</span>
        {% if active_operators.from_addr %}
        <span class="badge badge-neutral">
            <span class="font-medium">from:</span>{{ active_operators.from_addr }}
        </span>
        {% endif %}
        {% if active_operators.to_addr %}
        <span class="badge badge-neutral">
            <span class="font-medium">to:</span>{{ active_operators.to_addr }}
        </span>
        {% endif %}
        {% if active_operators.subject_contains %}
        <span class="badge badge-neutral">
            <span class="font-medium">subject:</span>{{ active_operators.subject_contains }}
        </span>
        {% endif %}
        {% if active_operators.has_attachments %}
        <span class="badge badge-warning">
            üìé has:attachment
        </span>
        {% endif %}
        {% if active_operators.is_unread is not none %}
        <span class="badge badge-info">
            is:{{ 'unread' if active_operators.is_unread else 'read' }}
        </span>
        {% endif %}
        {% if active_operators.is_starred %}
        <span class="badge badge-warning">
            ‚≠ê is:starred
        </span>
        {% endif %}
        {% if active_operators.attachment_filename %}
        <span class="badge badge-neutral">
            <span class="font-medium">attachment:</span>{{ active_operators.attachment_filename }}
        </span>
        {% endif %}
    </div>
    {% endif %}

    {% if query or (filters.from_addr or filters.date_from or filters.date_to or filters.has_attachments is not none or filters.is_unread is not none) %}
    <div class="space-y-3">
        <div class="flex items-center justify-between">
            <h2 class="text-lg font-medium text-body">
                {{ results|length }} result{% if results|length != 1 %}s{% endif %}
                {% if parsed_query %}for "{{ parsed_query }}"{% elif query %}for "{{ query }}"{% endif %}
                {% if mode == 'semantic' %}<span class="text-purple-500 text-sm ml-2">‚ú® semantic</span>{% endif %}
            </h2>
        </div>
        
        <div class="card p-0 overflow-hidden divide-y divide-border">
            {% if results %}
                {% for result in results %}
                <a href="/thread/{{ result.folder }}/{{ result.uid }}" 
                   class="block hover:bg-surface-hover transition-colors">
                    <div class="px-4 py-4">
                        <div class="flex items-center justify-between mb-1">
                            <div class="flex items-center gap-2">
                                {% if result.is_unread %}
                                <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                                {% endif %}
                                <p class="text-sm font-medium text-body">
                                    {{ result.from_name }}
                                </p>
                                {% if result.has_attachments %}
                                <span class="text-muted">üìé</span>
                                {% endif %}
                            </div>
                            <div class="flex items-center space-x-3">
                                {% if result.similarity %}
                                <span class="badge
                                    {% if result.similarity > 0.85 %}badge-success
                                    {% elif result.similarity > 0.7 %}badge-warning
                                    {% else %}badge-neutral{% endif %}">
                                    {{ "%.0f"|format(result.similarity * 100) }}% match
                                </span>
                                {% endif %}
                                <span class="text-sm text-muted">{{ result.date }}</span>
                            </div>
                        </div>
                        <p class="text-sm font-medium text-body">{{ result.subject }}</p>
                        <p class="text-sm text-muted mt-1">{{ result.preview }}</p>
                    </div>
                </a>
                {% endfor %}
            {% else %}
                {% with icon="üîç", title="No results found", description="Try adjusting your search terms or filters." %}
                    {% include "partials/empty_state.html" %}
                {% endwith %}
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="py-12">
        {% with icon="üîç", title="Search your emails", description="Enter a query to find what you're looking for. Use 'semantic' mode for AI-powered meaning search." %}
            {% include "partials/empty_state.html" %}
        {% endwith %}
        
        <div class="mt-8 max-w-2xl mx-auto">
            <p class="text-sm text-muted text-center mb-4">Try operators like:</p>
            <div class="flex flex-wrap justify-center gap-2 text-xs">
                <code class="px-2 py-1 bg-surface-subtle border border-border rounded text-body">from:sender@example.com</code>
                <code class="px-2 py-1 bg-surface-subtle border border-border rounded text-body">subject:meeting</code>
                <code class="px-2 py-1 bg-surface-subtle border border-border rounded text-body">has:attachment</code>
                <code class="px-2 py-1 bg-surface-subtle border border-border rounded text-body">is:unread</code>
            </div>
        </div>
    </div>
    {% endif %}

    <div x-show="showSaveModal" x-cloak 
         class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"
         @click.self="showSaveModal = false">
        <div class="bg-surface rounded-xl p-6 w-full max-w-md border border-border shadow-xl">
            <h3 class="h2 mb-4">Save Search</h3>
            <form hx-post="/search/save" hx-target="#saved-searches" hx-swap="innerHTML" @htmx:after-request="showSaveModal = false">
                <input type="hidden" name="query" value="{{ query }}">
                <input type="hidden" name="mode" value="{{ mode }}">
                <input type="hidden" name="folder" value="{{ folder }}">
                <input type="hidden" name="from" value="{{ filters.from_addr }}">
                <input type="hidden" name="date_from" value="{{ filters.date_from }}">
                <input type="hidden" name="date_to" value="{{ filters.date_to }}">
                {% if filters.has_attachments %}<input type="hidden" name="has_attachments" value="true">{% endif %}
                {% if filters.is_unread %}<input type="hidden" name="is_unread" value="true">{% endif %}
                
                <div class="mb-4">
                    <label class="block text-sm text-body mb-1">Search Name</label>
                    <input type="text" name="name" required autofocus
                           placeholder="e.g., Work emails this week"
                           class="input-field w-full">
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" @click="showSaveModal = false"
                            class="btn-secondary">
                        Cancel
                    </button>
                    <button type="submit"
                            class="btn-primary">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
